<!DOCTYPE html>
<html>
<head>
<title>chapter009-02-Nginx基本配置使用.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback";
	font-size: 14px;
	padding: 0 12px;
	line-height: 22px;
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}


body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	color: #4080D0;
	text-decoration: none;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

h1 code,
h2 code,
h3 code,
h4 code,
h5 code,
h6 code {
	font-size: inherit;
	line-height: auto;
}

a:hover {
	color: #4080D0;
	text-decoration: underline;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left: 5px solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 14px;
	line-height: 19px;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

.mac code {
	font-size: 12px;
	line-height: 18px;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

/** Theming */

.vscode-light,
.vscode-light pre code {
	color: rgb(30, 30, 30);
}

.vscode-dark,
.vscode-dark pre code {
	color: #DDD;
}

.vscode-high-contrast,
.vscode-high-contrast pre code {
	color: white;
}

.vscode-light code {
	color: #A31515;
}

.vscode-dark code {
	color: #D7BA7D;
}

.vscode-light pre:not(.hljs),
.vscode-light code > div {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre:not(.hljs),
.vscode-dark code > div {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre:not(.hljs),
.vscode-high-contrast code > div {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

.vscode-light blockquote,
.vscode-dark blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.vscode-high-contrast blockquote {
	background: transparent;
	border-color: #fff;
}
</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family:  "Meiryo", "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback";
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

</head>
<body>
<h2 id="%E7%AC%AC%E4%B9%9D%E7%AB%A0-nginx-%E6%9C%8D%E5%8A%A1%E5%99%A8">第九章 Nginx 服务器</h2>
<h3 id="%E7%AC%AC%E4%BA%8C%E8%8A%82-nginx-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8">第二节  Nginx 基础配置使用</h3>
<p>   Nginx 功能强大，我们可以通过配置文件来实现各功能</p>
<h4 id="921-centos76-%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%E7%9A%84-nginx-116">9.2.1 CentOS7.6 中使用编译安装的 Nginx 1.16</h4>
<ol>
<li>安装 Nginx</li>
</ol>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># yum remove firewalld</span>
Loaded plugins: fastestmirror
No Match <span class="hljs-keyword">for</span> argument: firewalld
No Packages marked <span class="hljs-keyword">for</span> removal
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># iptables -vnL</span>
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># setenforce 0</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># getenforce </span>
Permissive
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>编译安装完成 nginx1.16 然后创建 systemd 配置文件， 创建用户 nginx</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># tree /apps/</span>
/apps/
└── nginx
    ├── client_body_temp
    ├── conf
    │   ├── fastcgi.conf
    │   ├── fastcgi.conf.default
    │   ├── fastcgi_params
    │   ├── fastcgi_params.default
    │   ├── koi-utf
    │   ├── koi-win
    │   ├── mime.types
    │   ├── mime.types.default
    │   ├── nginx.conf
    │   ├── nginx.conf.default
    │   ├── scgi_params
    │   ├── scgi_params.default
    │   ├── uwsgi_params
    │   ├── uwsgi_params.default
    │   └── win-utf
    ├── fastcgi_temp
    ├── html
    │   ├── 50x.html
    │   └── index.html
    ├── logs
    │   ├── access.log
    │   ├── error.log
    │   └── nginx.pid
    ├── proxy_temp
    ├── sbin
    │   └── nginx
    ├── scgi_temp
    └── uwsgi_temp

10 directories, 21 files
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /usr/lib/systemd/system/nginx.service </span>
[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target
[Service]
Type=forking
PIDFile=/apps/nginx/logs/nginx.pid
<span class="hljs-comment"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span>
<span class="hljs-comment"># SELinux context. This might happen when running `nginx -t` from the cmdline.</span>
<span class="hljs-comment"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span>
ExecStartPre=/usr/bin/rm -f /apps/nginx/logs/nginx.pid
ExecStartPre=/apps/nginx/sbin/nginx -t
ExecStart=/apps/nginx/sbin/nginx
ExecReload=/bin/<span class="hljs-built_in">kill</span> -s HUP <span class="hljs-variable">$MAINPID</span>
<span class="hljs-comment">#KillSignal=SIGQUIT</span>
<span class="hljs-comment">#TimeoutStopSec=5</span>
KillMode=process
PrivateTmp=<span class="hljs-literal">true</span>
[Install]
WantedBy=multi-user.target
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># useradd nginx -s /sbin/nologin -u 2000</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># chown nginx.nginx -R /app/nginx/</span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># systemctl daemon-reload </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># systemctl start nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl 127.0.0.1</span>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=<span class="hljs-string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="hljs-string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="2">
<li>我们查看一下默认的配置文件</li>
</ol>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>

user  nginx;
worker_processes  1;

error_log  logs/error.log  info;

pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  <span class="hljs-string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
                      <span class="hljs-string">'$status $body_bytes_sent "$http_referer" '</span>
                     <span class="hljs-string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;

    access_log  logs/access.log  main;

    sendfile        on;
    tcp_nopush     on;

    keepalive_timeout  65;

    gzip  on;

    server {
        listen       80;
        server_name  localhost;

        <span class="hljs-comment">#charset koi8-r;</span>

        access_log  logs/host.access.log  main;

        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page  404              /404.html;

        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span>
        <span class="hljs-comment">#</span>
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

    }

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<pre class="hljs"><code><div>
上图中各项配置内容介绍：
1. user                           启动 nginx worker 进程的系统用户身份
2. worker_processes               启动 worker 进程的个数
3. error_log                      错误日志的存放路径， 以及错误级别[debug | info | notice | warn | error | crit | alert | emerg]
4. pid                            进程启动后 pid 文件所在的目录
5. events {}                      事件驱动配置段
   worker_connections             单个 worker 进程最大并发连接数

6. http {}                        http 功能配置段
   include                        包含的自配置文件
   log_format                     日志组成格式和内容， 可以给日志格式起一个名称 比如默认叫 main
   access_log                     访问日志存储路径和具体的日志格式，比如使用了上一行 log_format 定义的 main
   send_file                      是否开启 sendfile 功能， 默认是 on
   keepalive_timeout              默认的会话连接超时时间,单位为秒
   gzip                           是否开启 gzip 压缩发送的数据
   server{}                       http 内配置的虚拟主机
        listen                    监听的 ip 地址和端口号
        server_name               虚拟主机名
        access_log                访问指定 server 的日志
        location {}               客户端请求 url 配置条件
                  root            location 中指定的 文件存放系统路径
                  index           默认的 index 页面 后跟 index.html index.php
                  error_page      错误页面
</div></code></pre>
<h4 id="922-nginx-116-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E4%BB%8B%E7%BB%8D">9.2.2 Nginx 1.16 基础配置介绍</h4>
<ol>
<li>user 代表 nginx 服务的 worker 进程所属的系统用户身份，这里我配置为:</li>
</ol>
<pre class="hljs"><code><div>user  nginx;
</div></code></pre>
<p>启动服务后，查看进程，发现主进程为 root 用户发起， worker 进程由 nginx 用户发起：</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># ps aux | grep nginx</span>
root       7059  0.0  0.1  46268  1168 ?        Ss   19:36   0:00 nginx: master process /apps/nginx/sbin/nginx
nginx      7060  0.0  0.1  46652  1944 ?        S    19:36   0:00 nginx: worker process
root       7064  0.0  0.0 112708   980 pts/1    S+   19:37   0:00 grep --color=auto nginx
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="2">
<li>worker_processes 代表 nginx 服务启动的 worker 进程个数，我这里配置为:</li>
</ol>
<pre class="hljs"><code><div>user  nginx;
worker_processes  2;
</div></code></pre>
<p>重启服务后，查看进程，发现有一个主进程，2个 worker 进程：</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># ps aux | grep nginx</span>
root       7113  0.0  0.1  46268  1172 ?        Ss   19:50   0:00 nginx: master process /apps/nginx/sbin/nginx
nginx      7114  0.0  0.1  46652  1948 ?        S    19:50   0:00 nginx: worker process
nginx      7115  0.0  0.1  46652  1948 ?        S    19:50   0:00 nginx: worker process
root       7117  0.0  0.0 112708   976 pts/1    S+   19:50   0:00 grep --color=auto nginx
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl status nginx</span>
● nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Thu 2019-05-30 19:50:13 CST; 9s ago
  Process: 7111 ExecStart=/apps/nginx/sbin/nginx (code=exited, status=0/SUCCESS)
  Process: 7108 ExecStartPre=/apps/nginx/sbin/nginx -t (code=exited, status=0/SUCCESS)
  Process: 7106 ExecStartPre=/usr/bin/rm -f /apps/nginx/logs/nginx.pid (code=exited, status=0/SUCCESS)
 Main PID: 7113 (nginx)
   CGroup: /system.slice/nginx.service
           ├─7113 nginx: master process /apps/nginx/sbin/nginx
           ├─7114 nginx: worker process
           └─7115 nginx: worker process

May 30 19:50:13 localhost.localdomain systemd[1]: Starting The nginx HTTP and reverse pr.....
May 30 19:50:13 localhost.localdomain nginx[7108]: nginx: the configuration file /apps/n...ok
May 30 19:50:13 localhost.localdomain nginx[7108]: nginx: configuration file /apps/nginx...ul
May 30 19:50:13 localhost.localdomain systemd[1]: Started The nginx HTTP and reverse pro...r.
Hint: Some lines were ellipsized, use -l to show <span class="hljs-keyword">in</span> full.
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>我的 nginx 服务器的 cpu 一共有 4 个核心， 我们配置为 auto 时， nginx 会自动创建适当的 worker 进程，一般与核心数相同：</p>
<pre class="hljs"><code><div>user  nginx;
worker_processes  auto;
</div></code></pre>
<p>重启查看结果：</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl status nginx</span>
● nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Thu 2019-05-30 19:54:02 CST; 2s ago
  Process: 7158 ExecStart=/apps/nginx/sbin/nginx (code=exited, status=0/SUCCESS)
  Process: 7155 ExecStartPre=/apps/nginx/sbin/nginx -t (code=exited, status=0/SUCCESS)
  Process: 7153 ExecStartPre=/usr/bin/rm -f /apps/nginx/logs/nginx.pid (code=exited, status=0/SUCCESS)
 Main PID: 7160 (nginx)
   CGroup: /system.slice/nginx.service
           ├─7160 nginx: master process /apps/nginx/sbin/nginx
           ├─7161 nginx: worker process
           ├─7162 nginx: worker process
           ├─7163 nginx: worker process
           └─7164 nginx: worker process

May 30 19:54:02 localhost.localdomain systemd[1]: Starting The nginx HTTP and reverse pr.....
May 30 19:54:02 localhost.localdomain nginx[7155]: nginx: the configuration file /apps/n...ok
May 30 19:54:02 localhost.localdomain nginx[7155]: nginx: configuration file /apps/nginx...ul
May 30 19:54:02 localhost.localdomain systemd[1]: Started The nginx HTTP and reverse pro...r.
Hint: Some lines were ellipsized, use -l to show <span class="hljs-keyword">in</span> full.
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="3">
<li>worker_cpu_affinity 代表 worker 进程是否绑定在指定 cpu 核心上，以此来减小 cpu 切换带来的性能问题，配置为 auto 即可， 也可以数字掩码表示指定的cpu 核心， 下面我们指定开启2个 worker ，分别在 cpu0 和 cpu1 上运行:</li>
</ol>
<pre class="hljs"><code><div>user  nginx;
worker_processes 2;
worker_cpu_affinity 00010 0001;
</div></code></pre>
<p>重启发现，cpu 绑定成功</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># ps axo pid,cmd,psr | grep nginx</span>
  7273 nginx: master process /apps   1
  7274 nginx: worker process         1
  7275 nginx: worker process         0
  7277 grep --color=auto nginx       1
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>下面我们使用 auto ，自动绑定 cpu, 该功能在 nginx 1.9.10 版本才开始支持:</p>
<pre class="hljs"><code><div>user  nginx;
worker_processes 3;
worker_cpu_affinity auto;
</div></code></pre>
<p>重启， 查看结果：</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># ps axo pid,cmd,psr | grep nginx</span>
  7296 nginx: master process /apps   3
  7297 nginx: worker process         0
  7298 nginx: worker process         1
  7299 nginx: worker process         2
  7301 grep --color=auto nginx       0
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
</div></code></pre>
<ol start="4">
<li>error_log 代表错误日志信息，我们在编译的时候使用了 --with-debug 选项，所以支持 debug 日志级别， 当前一共有 debug，info，notice，warn，error，crit，alert，emerg 8种基本，debug 信息最详细，日志的位置在 /apps/nginx/log/error.log , 我们配置为 debug 模式：</li>
</ol>
<pre class="hljs"><code><div>user  nginx;

worker_processes 3;
worker_cpu_affinity auto;

error_log  logs/error.log  debug;
</div></code></pre>
<p>删除之前的老日志文件， 重启服务， 进行访问默认主页， 然后查看日志：</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># rm -rf /apps/nginx/logs/error.log </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl 127.0.0.1</span>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=<span class="hljs-string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="hljs-string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/logs/error.log </span>
2019/05/30 20:20:41 [debug] 7368<span class="hljs-comment">#0: bind() 0.0.0.0:80 #6 </span>
2019/05/30 20:20:41 [debug] 7368<span class="hljs-comment">#0: counter: 00007FFAFF03B080, 1</span>
2019/05/30 20:20:41 [debug] 7373<span class="hljs-comment">#0: bind() 0.0.0.0:80 #6 </span>
2019/05/30 20:20:41 [notice] 7373<span class="hljs-comment">#0: using the "epoll" event method</span>
2019/05/30 20:20:41 [debug] 7373<span class="hljs-comment">#0: counter: 00007F84C20D0080, 1</span>
2019/05/30 20:20:41 [notice] 7373<span class="hljs-comment">#0: nginx/1.16.0</span>
2019/05/30 20:20:41 [notice] 7373<span class="hljs-comment">#0: built by gcc 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) </span>
2019/05/30 20:20:41 [notice] 7373<span class="hljs-comment">#0: OS: Linux 3.10.0-957.el7.x86_64</span>
2019/05/30 20:20:41 [notice] 7373<span class="hljs-comment">#0: getrlimit(RLIMIT_NOFILE): 1024:4096</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: write: 7, 00007FFEB4F766F0, 5, 0</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: setproctitle: "nginx: master process /apps/nginx/sbin/nginx"</span>
2019/05/30 20:20:41 [notice] 7374<span class="hljs-comment">#0: start worker processes</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: channel 3:7</span>
2019/05/30 20:20:41 [notice] 7374<span class="hljs-comment">#0: start worker process 7375</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: channel 8:9</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: add cleanup: 00000000023DA8C8</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: malloc: 00000000023BCBC0:8</span>
2019/05/30 20:20:41 [notice] 7374<span class="hljs-comment">#0: start worker process 7376</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: add cleanup: 00000000023DA8C8</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: pass channel s:1 pid:7376 fd:8 to s:0 pid:7375 fd:3</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: channel 10:11</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: malloc: 00000000023BCBC0:8</span>
2019/05/30 20:20:41 [notice] 7374<span class="hljs-comment">#0: start worker process 7377</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: pass channel s:2 pid:7377 fd:10 to s:0 pid:7375 fd:3</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: pass channel s:2 pid:7377 fd:10 to s:1 pid:7376 fd:8</span>
2019/05/30 20:20:41 [debug] 7374<span class="hljs-comment">#0: sigsuspend</span>
2019/05/30 20:20:41 [notice] 7376<span class="hljs-comment">#0: sched_setaffinity(): using cpu #1</span>
2019/05/30 20:20:41 [notice] 7375<span class="hljs-comment">#0: sched_setaffinity(): using cpu #0</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: notify eventfd: 11</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: notify eventfd: 9</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: testing the EPOLLRDHUP flag: success</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: testing the EPOLLRDHUP flag: success</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: malloc: 00000000023C1EC0:6144</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: malloc: 00007F84C2084010:245760</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: malloc: 00000000023C1EC0:6144</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: malloc: 00007F84C2084010:245760</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: malloc: 00000000023DF2D0:98304</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: malloc: 00000000023DF2D0:98304</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: malloc: 00000000023F72E0:98304</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: malloc: 00000000023F72E0:98304</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: epoll add event: fd:6 op:1 ev:00002001</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: epoll add event: fd:6 op:1 ev:00002001</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: epoll add event: fd:7 op:1 ev:00002001</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: setproctitle: "nginx: worker process"</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: epoll timer: -1</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: epoll add event: fd:9 op:1 ev:00002001</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: setproctitle: "nginx: worker process"</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: epoll: fd:7 ev:0001 d:00007F84C2084100</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: epoll timer: -1</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: channel handler</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: epoll: fd:9 ev:0001 d:00007F84C2084100</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: channel handler</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: channel: 32</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: channel command: 1</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: channel: 32</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: get channel s:1 pid:7376 fd:3</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: channel command: 1</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: get channel s:2 pid:7377 fd:7</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: channel: 32</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: channel command: 1</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: channel: -2</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: get channel s:2 pid:7377 fd:10</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: timer delta: 6</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: channel: -2</span>
2019/05/30 20:20:41 [debug] 7376<span class="hljs-comment">#0: epoll timer: -1</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: timer delta: 6</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:41 [debug] 7375<span class="hljs-comment">#0: epoll timer: -1</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: add cleanup: 00000000023DA8C8</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: malloc: 00000000023BCBC0:8</span>
2019/05/30 20:20:41 [notice] 7377<span class="hljs-comment">#0: sched_setaffinity(): using cpu #2</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: notify eventfd: 13</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: testing the EPOLLRDHUP flag: success</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: malloc: 00000000023C1EC0:6144</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: malloc: 00007F84C2084010:245760</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: malloc: 00000000023DF2D0:98304</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: malloc: 00000000023F72E0:98304</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: epoll add event: fd:6 op:1 ev:00002001</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: epoll add event: fd:11 op:1 ev:00002001</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: setproctitle: "nginx: worker process"</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:41 [debug] 7377<span class="hljs-comment">#0: epoll timer: -1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: epoll: fd:6 ev:0001 d:00007F84C2084010</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: accept on 0.0.0.0:80, ready: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: posix_memalign: 00000000023CD360:512 @16</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 accept: 127.0.0.1:48212 fd:7</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 event timer add: 7: 60000:14471029</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 reusable connection: 1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 epoll add event: fd:7 op:1 ev:80002001</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: timer delta: 8114</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: epoll timer: 60000</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: epoll: fd:7 ev:0001 d:00007F84C20841F0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http wait request handler</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 malloc: 00000000023CD570:1024</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 recv: eof:0, avail:1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 recv: fd:7 73 of 1024</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 reusable connection: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 posix_memalign: 00000000023C36D0:4096 @16</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http process request line</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http request line: "GET / HTTP/1.1"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http uri: "/"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http args: ""</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http exten: ""</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 posix_memalign: 00000000023B75F0:4096 @16</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http process request header line</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http header: "User-Agent: curl/7.29.0"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http header: "Host: 127.0.0.1"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http header: "Accept: */*"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http header done</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 event timer del: 7: 14471029</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 rewrite phase: 1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 test location: "/"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 using configuration "/"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http cl:-1 max:1048576</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 rewrite phase: 3</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 post rewrite phase: 4</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 5</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 6</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 7</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 access phase: 8</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 access phase: 9</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 post access phase: 10</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 11</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 12</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 content phase: 13</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 open index "/apps/nginx/html/index.html"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 internal redirect: "/index.html?"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 rewrite phase: 1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 test location: "/"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 test location: "50x.html"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 using configuration "/"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http cl:-1 max:1048576</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 rewrite phase: 3</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 post rewrite phase: 4</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 5</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 6</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 7</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 access phase: 8</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 access phase: 9</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 post access phase: 10</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 11</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 generic phase: 12</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 content phase: 13</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 content phase: 14</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 content phase: 15</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 content phase: 16</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http filename: "/apps/nginx/html/index.html"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 add cleanup: 00000000023C43F8</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http static fd: 9</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http set discard body</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 HTTP/1.1 200 OK</span>
Server: nginx/1.16.0
Date: Thu, 30 May 2019 12:20:49 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Thu, 30 May 2019 06:14:17 GMT
Connection: keep-alive
ETag: <span class="hljs-string">"5cef74b9-264"</span>
Accept-Ranges: bytes

2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 write new buf t:1 f:0 00000000023C45C0, pos 00000000023C45C0, size: 238 file: 0, size: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http write filter: l:0 f:0 s:238</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http output filter "/index.html?"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http copy filter: "/index.html?"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http postpone filter "/index.html?" 00007FFEB4F76110</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 write old buf t:1 f:0 00000000023C45C0, pos 00000000023C45C0, size: 238 file: 0, size: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 write new buf t:0 f:1 0000000000000000, pos 0000000000000000, size: 0 file: 0, size: 612</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http write filter: l:1 f:0 s:850</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http write filter limit 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 writev: 238 of 238</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 sendfile: @0 612</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 sendfile: 612 of 612 @0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http write filter 0000000000000000</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http copy filter: 0 "/index.html?"</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http finalize request: 0, "/index.html?" a:1, c:2</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http request count:2 blk:0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http finalize request: -4, "/index.html?" a:1, c:1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 set http keepalive handler</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http close request</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http log handler</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 run cleanup: 00000000023C43F8</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 file cleanup: fd:9</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 free: 00000000023C36D0, unused: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 free: 00000000023B75F0, unused: 2864</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 free: 00000000023CD570</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 hc free: 0000000000000000</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 hc busy: 0000000000000000 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 tcp_nodelay</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 reusable connection: 1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 event timer add: 7: 65000:14476029</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: timer delta: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: epoll timer: 65000</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: epoll: fd:7 ev:2001 d:00007F84C20841F0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 http keepalive handler</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 malloc: 00000000023CD570:1024</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 recv: eof:1, avail:1</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 recv: fd:7 0 of 1024</span>
2019/05/30 20:20:49 [info] 7377<span class="hljs-comment">#0: *1 client 127.0.0.1 closed keepalive connection</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 close http connection: 7</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 event timer del: 7: 14476029</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 reusable connection: 0</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 free: 00000000023CD570</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: *1 free: 00000000023CD360, unused: 136</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: timer delta: 2</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: worker cycle</span>
2019/05/30 20:20:49 [debug] 7377<span class="hljs-comment">#0: epoll timer: -1</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>日志还是相当详细的， 通过日志，可以了解到 nginx 处理 http 请求的信息过程</p>
<ol start="5">
<li>pid 代表 nginx 主进程的 pid 文件存放位置</li>
</ol>
<pre class="hljs"><code><div>user  nginx;

worker_processes 3;
worker_cpu_affinity auto;

error_log  logs/error.log  debug;

pid        logs/nginx.pid;
</div></code></pre>
<p>重启查看 pid 文件位置信息</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># ls -al /apps/nginx/logs/nginx.pid </span>
-rw-r--r-- 1 root root 5 May 30 20:44 /apps/nginx/logs/nginx.pid
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/logs/nginx.pid </span>
7604
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl status nginx</span>
● nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; disabled; vendor preset: disabled)
   Active: active (running) since Thu 2019-05-30 20:44:06 CST; 3min 4s ago
  Process: 7602 ExecStart=/apps/nginx/sbin/nginx (code=exited, status=0/SUCCESS)
  Process: 7598 ExecStartPre=/apps/nginx/sbin/nginx -t (code=exited, status=0/SUCCESS)
  Process: 7596 ExecStartPre=/usr/bin/rm -f /apps/nginx/logs/nginx.pid (code=exited, status=0/SUCCESS)
 Main PID: 7604 (nginx)
   CGroup: /system.slice/nginx.service
           ├─7604 nginx: master process /apps/nginx/sbin/nginx
           ├─7605 nginx: worker process
           ├─7606 nginx: worker process
           └─7607 nginx: worker process

May 30 20:44:06 localhost.localdomain systemd[1]: Starting The nginx HTTP and reverse pr.....
May 30 20:44:06 localhost.localdomain nginx[7598]: nginx: the configuration file /apps/n...ok
May 30 20:44:06 localhost.localdomain nginx[7598]: nginx: configuration file /apps/nginx...ul
May 30 20:44:06 localhost.localdomain systemd[1]: Started The nginx HTTP and reverse pro...r.
Hint: Some lines were ellipsized, use -l to show <span class="hljs-keyword">in</span> full.
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
</div></code></pre>
<ol start="6">
<li>events 代表请求连接处理相关的配置，work 的具体配置可以在这里定义， 下面我们指定每个 worker<br>
可以处理的最大并发连接数 worker_connections 为65536。 accept_mutex 默认值为 off ，表示当有一<br>
个新请求时，会轮询的唤醒空闲的 worker 进程，如果设置为 on ，则默认唤醒全部空闲的 worker 进程。<br>
muti_accept 默认表示 worker 同一时间只等接受一个网络连接请求，设置为 on 后， 可以同一时间接受<br>
多个网络连接请求，kqueue 默认忽略该选项。</li>
</ol>
<pre class="hljs"><code><div>events {
    worker_connections  65536;
    accept_mutex on;
    multi_accept on;
}
</div></code></pre>
<ol start="7">
<li>
<p>http 代表 nginx 处理 http 请求时的相关配置选项段<br>
7.1. include mime.types; 代表加载 conf 路径下 mime.types 文件<br>
7.2. default_type  application/octet-stream; 代表提示下载 mime.types 中不支持的文件类型<br>
7.3. log_format 代表日志格式， 可以自定义一个名称，格式内容为自定义字符和 nginx 内置变量信息的组合<br>
7.4. access_log 代表 http 的访问日志存放在文件系统中的路径，路径后要指明日志格式<br>
7.5. sendfile   代表是否要开启 sendfile 功能，该功能可以减少拷贝内核数据<br>
到用户空间的过程，提高响应数据速度，减少内存开销。<br>
7.6. keepalive_timeout 网络会后连接时长，默认 75 秒，设置为 0 时表示关闭<br>
7.7. gzip on 代表是否开启数据传输压缩。<br>
7.8. server{} 代表 http 虚拟主机配置段<br>
7.8.1. listen 代表该虚拟主机监听的 主机地址和端口号，比如： listen 192.168.130.132:80;<br>
7.8.2.  server_name 代表主机名，比如：www.magedu.com<br>
7.9. location{} 代表访问路径匹配规则配置段<br>
7.9.1 root      代表改匹配规则下对应文件在文件系统中的存放路径
7.9.2 index     代表默认主页文件，后面根据顺序可以写 index.html index.php 等</p>
</li>
<li>
<p>http 中配置实现两个虚拟主机</p>
</li>
</ol>
<pre class="hljs"><code><div>配置文件如下：
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
user  nginx;
worker_processes 3;
worker_cpu_affinity auto;
error_log  logs/error.log  debug;
pid        logs/nginx.pid;

events {
    worker_connections  65536;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    sendfile        on;

    keepalive_timeout  65;

    server {
        listen       80;
        server_name  www.magedu.com;

        location / {
            root   html/mageducom;
            index  index.html index.htm;
        }
    }

    server {
        listen       80;
	server_name  www.magedu.net;
	
	location / {
            root html/magedunet;
            index  index.html index.htm;
	}
    }

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>

创建两个虚拟主机对应的主页，并配置域名解析信息，进行测试：
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "www.magedu.com" &gt; /apps/nginx/html/mageducom/index.html</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "www.magedu.net" &gt; /apps/nginx/html/magedunet/index.html</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /etc/hosts</span>
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.130.132 www.magedu.com www.magedu.net
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.com</span>
www.magedu.com
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net</span>
www.magedu.net
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>多虚拟主机演示成功</p>
<h4 id="923-nginx-116-%E4%B8%AD-http-%E7%9A%84%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD%E9%85%8D%E7%BD%AE">9.2.3 Nginx 1.16 中 http 的常用功能配置</h4>
<p>删除之前 /apps/nginx， 进入之前的 nginx 编译文件中重新安装纯新的 Nginx1.16</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># rm -rf /apps/nginx/</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># ls -al /apps/</span>
total 0
drwxr-xr-x.  2 root root   6 May 31 18:25 .
dr-xr-xr-x. 18 root root 236 May 30 14:14 ..
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># ll</span>
total 1016
-rw-------. 1 root root    1368 Apr 27 16:21 anaconda-ks.cfg
drwxr-xr-x. 9 1001 1001     186 May 30 14:11 nginx-1.16.0
-rw-r--r--. 1 root root 1032345 Apr 23 21:58 nginx-1.16.0.tar.gz
[root@localhost ~]<span class="hljs-comment"># cd nginx-1.16.0/</span>
[root@localhost nginx-1.16.0]<span class="hljs-comment"># </span>
[root@localhost nginx-1.16.0]<span class="hljs-comment"># make install</span>
make -f objs/Makefile install
make[1]: Entering directory /root/nginx-1.16.0
.
.
.省略部分安装输出信息.....
.
.
	|| mkdir -p /apps/nginx/logs
<span class="hljs-built_in">test</span> -d /apps/nginx/logs \
	|| mkdir -p /apps/nginx/logs
<span class="hljs-built_in">test</span> -d /apps/nginx/html \
	|| cp -R html /apps/nginx
<span class="hljs-built_in">test</span> -d /apps/nginx/logs \
	|| mkdir -p /apps/nginx/logs
make[1]: Leaving directory /root/nginx-1.16.0
[root@localhost nginx-1.16.0]<span class="hljs-comment"># </span>
[root@localhost nginx-1.16.0]<span class="hljs-comment"># </span>
[root@localhost nginx-1.16.0]<span class="hljs-comment"># cd </span>
[root@localhost ~]<span class="hljs-comment"># ls -al /apps/nginx/</span>
total 0
drwxr-xr-x  6 root root  54 May 31 18:26 .
drwxr-xr-x. 3 root root  19 May 31 18:26 ..
drwxr-xr-x  2 root root 333 May 31 18:26 conf
drwxr-xr-x  2 root root  40 May 31 18:26 html
drwxr-xr-x  2 root root   6 May 31 18:26 logs
drwxr-xr-x  2 root root  19 May 31 18:26 sbin
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
</div></code></pre>
<ol>
<li>创建一个虚拟主机，配置文件单独存放与 conf.d 路径下， 主机名为 www.magedu.net, 站点数据路径单独存放于<br>
/data/nginx/html/pc 路径中，下面我们演示一下：</li>
</ol>
<pre class="hljs"><code><div>在 http {} 配置段的最后一行添加上 include 配置段，实现读取字配置文件功能
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
user  apache;
worker_processes  3;

<span class="hljs-comment">#error_log  logs/error.log;</span>
<span class="hljs-comment">#error_log  logs/error.log  notice;</span>
<span class="hljs-comment">#error_log  logs/error.log  info;</span>

<span class="hljs-comment">#pid        logs/nginx.pid;</span>


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    <span class="hljs-comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span class="hljs-comment">#                  '$status $body_bytes_sent "$http_referer" '</span>
    <span class="hljs-comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span>

    <span class="hljs-comment">#access_log  logs/access.log  main;</span>

    sendfile        on;
    <span class="hljs-comment">#tcp_nopush     on;</span>

    <span class="hljs-comment">#keepalive_timeout  0;</span>
    keepalive_timeout  65;

    <span class="hljs-comment">#gzip  on;</span>

    server {
        listen       80;
        server_name  localhost;

        <span class="hljs-comment">#charset koi8-r;</span>

        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span>

        location / {
            root   html;
            index  index.html index.htm;
        }

        <span class="hljs-comment">#error_page  404              /404.html;</span>

        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span>
        <span class="hljs-comment">#</span>
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
    include /apps/nginx/conf/conf.d/*.conf;

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/conf.d/pc.conf</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf</span>
server {
	listen    		80;
	server_name		www.magedu.net;
 	location / {
		root 	/data/nginx/html/pc;
	}

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># mkdir -pv /data/nginx/html/pc</span>
mkdir: created directory ‘/data’
mkdir: created directory ‘/data/nginx’
mkdir: created directory ‘/data/nginx/html’
mkdir: created directory ‘/data/nginx/html/pc’
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "www.magedu.net pc " &gt; /data/nginx/html/pc/index.html</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /etc/hosts</span>
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.130.132 www.magedu.com www.magedu.net
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net</span>
www.magedu.net pc 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>演示成功！</p>
<ol start="2">
<li>新建一个 mobile web 虚拟主机站点， 配置文件要求在 conf.d/mobile.conf 中，数据文件在<br>
/data/nginx/html/mobile 中，主机名为 mobile.magedu.net</li>
</ol>
<pre class="hljs"><code><div>同第一个实验一样，在 nginx 主配置文件中添加 include 语句：
include /apps/nginx/conf/conf.d/*.conf;

创建 mobile.conf 配置文件：
[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/conf.d/mobile.conf</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/mobile.conf</span>
server {
	listen 		80;
	server_name 	mobile.magedu.net;
	
	location / {
		root 	/data/nginx/html/mobile;
		index	index.html;
	}
}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># mkdir -pv /data/nginx/html/mobile</span>
mkdir: created directory ‘/data/nginx/html/mobile’
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "mobile web" &gt; /data/nginx/html/mobile/index.html</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># vi /etc/hosts</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /etc/hosts</span>
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.130.132 www.magedu.com www.magedu.net mobile.magedu.net
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl mobile.magedu.net</span>
mobile web
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>演示成功！</p>
<ol start="3">
<li>nginx 在响应用户请求时会根据 location的匹配 和 root 的组合去文件系统中加载对应的资源。下面给大家演示一下 alias<br>
的用法，使用 alias 后， nginx 会根据 location 中定义的 alias 路径直接去文件系统中加载对应资源。下我们创建一个虚拟<br>
主机，进行对比演示：</li>
</ol>
<pre class="hljs"><code><div>首先在主配置文件的 http 中添加 include 配置信息：
include /apps/nginx/conf/conf.d/*.conf;

创建虚拟主机配置文件：
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/conf.d/pc.conf </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}

	location /about {
		<span class="hljs-built_in">alias</span>	/data/nginx/html/pc;
		index	index.html;
	}

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># ls /data/nginx/html/pc/index.html </span>
/data/nginx/html/pc/index.html
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /data/nginx/html/pc/index.html </span>
www.magedu.net pc 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /etc/hosts</span>
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.130.132 www.magedu.com www.magedu.net mobile.magedu.net
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment">#  </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net</span>
www.magedu.net pc 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/</span>
www.magedu.net pc 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/about</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.16.0&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/about/</span>
www.magedu.net pc 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="4">
<li>server 中的 location 用来匹配请求 uri ，下面我们演示在一个虚拟主机中配置两个 location 进行匹配，<br>
其中一个使用 <code>=</code> 进行精确匹配，优先级最高:</li>
</ol>
<pre class="hljs"><code><div>首先在主配置文件的 http 中添加 include 配置信息：
include /apps/nginx/conf/conf.d/*.conf;

修改配置文件：
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/conf.d/pc.conf </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}

	location = /1.jpg {
		root 	/var/www/nginx/images;
		index	index.html;
	}

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># mkdir -pv /var/www/nginx/images</span>
mkdir: created directory ‘/var/www/nginx’
mkdir: created directory ‘/var/www/nginx/images’
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "1.jpg file" &gt; /var/www/nginx/images/i.jpg</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /var/www/nginx/images/1.jpg </span>
1.jpg file
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># cat /data/nginx/html/pc/index.html </span>
www.magedu.net pc 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># cat /etc/hosts</span>
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.130.132 www.magedu.com www.magedu.net mobile.magedu.net
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net</span>
www.magedu.net pc 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/1.jpg</span>
1.jpg file
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>location 使用 = 进行精确匹配成功</p>
<ol start="5">
<li>location 除了精确匹配，还支持正则表达式匹配 ~，我们在 test 文件夹下进行测试</li>
</ol>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/conf.d/pc.conf</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf</span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}

	location = /1.jpg {
		root 	/var/www/nginx/images;
		index	index.html;
	}

	location ~ /A.?\.jpg {

		root    /var/www/nginx/<span class="hljs-built_in">test</span>;
		index   index.html;
	}

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># mkdir -pv /var/www/nginx/test</span>
mkdir: created directory ‘/var/www/nginx/<span class="hljs-built_in">test</span>’
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "index.html in test dir" &gt; /var/www/nginx/test/index.html </span>
[root@localhost ~]<span class="hljs-comment">#  </span>
[root@localhost ~]<span class="hljs-comment"># echo "Aa.jpg in test dir" &gt; /var/www/nginx/test/Aa.jpg</span>
[root@localhost ~]<span class="hljs-comment">#  </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/Aa.jpg</span>
Aa.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> dir
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/aa.jpg</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.16.0&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>使用正则表达式 ~ 符号时，可以在其后添加 * 表示忽略大小写，如图：</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/conf.d/pc.conf </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat  /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}

	location = /1.jpg {
		root 	/var/www/nginx/images;
		index	index.html;
	}

	location ~* /A.?\.jpg {

		root    /var/www/nginx/<span class="hljs-built_in">test</span>;
		index   index.html;
	}

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/Aa.jpg</span>
Aa.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> dir
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/aa.jpg</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.16.0&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<p>上图中我们使用了 ~* 配置location 但是依旧没有访问成功 aa.jpg, 原因在于，location 的正则表达式<br>
只用来匹配 uri，匹配成功后依旧要使用源 uri 中的文件名在对应的 location 指定的 root 目录下去寻<br>
找文件，由于我们没有创建 aa.jpg 这个文件，因此返回 404 错误码。 上述过程可以使用 debug 模式下查看错误日志验证：</p>
<pre class="hljs"><code><div>2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 test location: "/"</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 test location: "1.jpg"</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 test location: ~ "/A.?\.jpg"</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 using configuration "/A.?\.jpg"</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 http cl:-1 max:1048576</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 rewrite phase: 3</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 post rewrite phase: 4</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 generic phase: 5</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 generic phase: 6</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 generic phase: 7</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 access phase: 8</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 access phase: 9</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 post access phase: 10</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 generic phase: 11</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 generic phase: 12</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 content phase: 13</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 content phase: 14</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 content phase: 15</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 content phase: 16</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 http filename: "/var/www/nginx/test/aa.jpg"</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 add cleanup: 0000000001A3C3F8</span>
2019/06/09 10:10:56 [error] 24527<span class="hljs-comment">#0: *5 open() "/var/www/nginx/test/aa.jpg" failed (2: No such file or directory), client: 127.0.0.1, server: www.magedu.net, request: "GET /aa.jpg HTTP/1.1", host: "www.magedu.net"</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 http finalize request: 404, "/aa.jpg?" a:1, c:1</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 http special response: 404, "/aa.jpg?"</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 http set discard body</span>
2019/06/09 10:10:56 [debug] 24527<span class="hljs-comment">#0: *5 HTTP/1.1 404 Not Found</span>
</div></code></pre>
<p>现在我们创建对应的 aa.jpg 文件，可以正常获取。</p>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># echo "aa.jpg in test dir" &gt; /var/www/nginx/test/aa.jpg</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/aa.jpg</span>
aa.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> dir
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="6">
<li>location 使用正则表达式时，可以使用 ^~ 表示 uri 以什么开头， 使用 $ 表示已 uri 以什么结尾</li>
</ol>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/conf.d/pc.conf </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}

	location = /1.jpg {
		root 	/var/www/nginx/images;
		index	index.html;
	}

	location ^~ /image {

		root    /var/www/nginx/<span class="hljs-built_in">test</span>;
		index   index.html;
	}
        
    location /images {
	        root	/var/www/nginx;
                index   index.html;
	}

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># cd /var/www/nginx/</span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># tree</span>
.
├── images
│   └── 2.jpg
└── <span class="hljs-built_in">test</span>
    ├── image
    │   └── 1.jpg
    └── images
        └── 2.jpg

4 directories, 3 files
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat images/2.jpg </span>
2.jpg <span class="hljs-keyword">in</span> nginx images dir
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat test/images/2.jpg </span>
2.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> image dir
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat test/image/1.jpg </span>
1.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> image dir
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment">#</span>
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net/image/1.jpg</span>
1.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> image dir
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net/images/2.jpg</span>
2.jpg <span class="hljs-keyword">in</span> nginx images dir
[root@localhost nginx]<span class="hljs-comment">#</span>
</div></code></pre>
<p>现在我们将配置文件修改一下，然后再进行访问测试：</p>
<pre class="hljs"><code><div>[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf</span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}

	location = /1.jpg {
		root 	/var/www/nginx/images;
		index	index.html;
	}

	location ^~ /image {

		root    /var/www/nginx/<span class="hljs-built_in">test</span>;
		index   index.html;
	}
        
    	<span class="hljs-comment">#location /images {</span>
	<span class="hljs-comment">#        root	/var/www/nginx;</span>
        <span class="hljs-comment">#        index   index.html;</span>
	<span class="hljs-comment">#}</span>

}
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment">#</span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net/image/1.jpg</span>
1.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> image dir
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net/images/2.jpg</span>
2.jpg <span class="hljs-keyword">in</span> <span class="hljs-built_in">test</span> image dir
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment">#</span>
</div></code></pre>
<p>通过上面的对比测试，我们发现完全匹配的优先级高于正则表达式的 ^~ 开头匹配</p>
<ol start="7">
<li>使用正则表达式时，使用 $ 符号表示 uri 已什么结尾，如图：</li>
</ol>
<pre class="hljs"><code><div>[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}

	location = /1.jpg {
		root 	/var/www/nginx/images;
		index	index.html;
	}

	location ~* \.(gif|jpg|jpeg)$ {

		root    /var/www/nginx/images;
		index   index.html;
	}
        

}
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># tree</span>
.
└── images
    ├── 1.gif
    ├── 1.jpeg
    └── 1.jpg

1 directory, 3 files
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat images/1.gif </span>
gif image
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat images/1.jpg </span>
jpg image
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># cat images/1.jpeg</span>
jpeg image
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment">#</span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># systemctl start nginx</span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net/1.jpg</span>
jpg image
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net/1.jpeg</span>
jpeg image
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net/1.gif</span>
gif image
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="8">
<li>location 的匹配优先级</li>
</ol>
<pre class="hljs"><code><div>1. =        的优先级最高
2. ^~       排第二
3. ~/~*     排第三
4. /        排最后

</div></code></pre>
<ol start="9">
<li>生产常用配置技巧</li>
</ol>
<pre class="hljs"><code><div>1. 使用 = 号，减少location 匹配过程，加速主页访问
location = / {

}


2. 创建一个 / 路径 location ，方便未匹配的资源访问
location / {

}


3. 规范静态资源请求 uri 划分，统一以 static 或其他自定义字符串开头
location ^~ /static {

}

或者不需要集中管理静态资源，使用文件后缀名进行匹配
location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ {

}

4. 一个 nginx 不是或者管理多个项目时，使用前缀字符进行分隔
location ~* /app1 {

}

location ~* /app2 {

}
</div></code></pre>
<ol start="10">
<li>nginx 中实现访问控制，ngx_http_access_module 模块提供 allow 和 deny 配置字段，<br>
在对应字段后添加指定的 ip 地址即可实现客户端 ip 地址过滤功能：</li>
</ol>
<pre class="hljs"><code><div>修改配置文件
[root@localhost nginx]<span class="hljs-comment"># cat  /apps/nginx/conf/conf.d/pc.conf</span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;

		deny 	192.168.130.133;
		allow 	192.168.130.132;
		allow	127.0.0.1;
		deny	all;
	}
}
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost nginx]<span class="hljs-comment"># </span>
[root@localhost nginx]<span class="hljs-comment"># curl www.magedu.net</span>
&lt;h1&gt; It works !&lt;/h1&gt;
[root@localhost nginx]<span class="hljs-comment"># </span>
</div></code></pre>
<ol start="11">
<li>nginx 中配置用户名密码验证访问控制</li>
</ol>
<pre class="hljs"><code><div>和 httpd 服务类似，我们使用 httpd 工具生成用户名密码配置文件：
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># yum install httpd-tools -y</span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: ftp.sjtu.edu.cn
 * epel: mirror01.idc.hinet.net
 * extras: mirror.lzu.edu.cn
 * updates: mirror.lzu.edu.cn
Package httpd-tools-2.4.6-89.el7.centos.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># htpasswd -cbm /apps/nginx/conf/.htpasswd magedu 123456</span>
Adding password <span class="hljs-keyword">for</span> user magedu
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># htpasswd -bm /apps/nginx/conf/.htpasswd gordon 123456</span>
Adding password <span class="hljs-keyword">for</span> user gordon
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/.htpasswd </span>
magedu:<span class="hljs-variable">$apr1</span><span class="hljs-variable">$bl7FwHjB</span><span class="hljs-variable">$h</span>/93ul8SbRqrCv/cg9DAL.
gordon:<span class="hljs-variable">$apr1</span><span class="hljs-variable">$U1ryr9Ij</span><span class="hljs-variable">$mLz</span>.RMvB0eJGiwmrd95p2/
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}
	
	location /login/ {
		root /data/nginx/html/login;
		index 	index.html;
	}
}
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># mkdir -pv /data/nginx/html/login</span>
mkdir: created directory ‘/data/nginx/html/login’
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "welcom to login default page " &gt; /data/nginx/html/login/index.html</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># curl -u magedu  www.magedu.net/login/index.html</span>
Enter host password <span class="hljs-keyword">for</span> user <span class="hljs-string">'magedu'</span>:
welcom to login default page 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="12">
<li>配置默认错误页面</li>
</ol>
<pre class="hljs"><code><div>[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

	error_page		500 502 503 504 404 /errorpage.html;
	location = /errorpage.html {
		root 	/data/nginx/html;
	}

 	location / {
		root 	/data/nginx/html/pc;
		index 	index.html;
	}
}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo 'default error page for nginx !' &gt; /data/nginx/html/errorpage.html</span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net</span>
&lt;h1&gt; It works !&lt;/h1&gt;
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/magedu.html</span>
default error page <span class="hljs-keyword">for</span> nginx !
[root@localhost ~]<span class="hljs-comment">#</span>

通过查看刚才的访问请求的错误日志，可以显示这个过程：
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 http filename: "/data/nginx/html/pc/magedu.html"</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 add cleanup: 0000000001794400</span>
2019/06/09 18:07:34 [error] 26000<span class="hljs-comment">#0: *3 open() "/data/nginx/html/pc/magedu.html" failed (2: No such file or directory), client: 127.0.0.1, server: www.magedu.net, request: "GET /magedu.html HTTP/1.1", host: "www.magedu.net"</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 http finalize request: 404, "/magedu.html?" a:1, c:1</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 http special response: 404, "/magedu.html?"</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 internal redirect: "/errorpage.html?"</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 rewrite phase: 1</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 test location: "/"</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 test location: "errorpage.html"</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 using configuration "=/errorpage.html"</span>
2019/06/09 18:07:34 [debug] 26000<span class="hljs-comment">#0: *3 http cl:-1 max:1048576</span>
</div></code></pre>
<ol start="13">
<li>使用 try_files 配置选项，当匹配 location 后尝试安装指定的查询文件顺序去指定路径下查找响应文件</li>
</ol>
<pre class="hljs"><code><div>我们配置一个 try_files 在当前 root 路径下查找，如果找不到继续查找 root 下 /about/default.html 的文件是否存在，如果存在则响应，不存在则 报错 500 状态码：

[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

	error_page		500 502 503 504 404 /errorpage.html;
	location = /errorpage.html {
		root 	/data/nginx/html;
	}

 	location /about {
		root 	/data/nginx/html;
		index 	index.html;
		try_files       <span class="hljs-variable">$uri</span>	/about/default.html;
	}
}
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># mkdir -pv about</span>
mkdir: created directory ‘about’
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># echo "try_files /about/default.html " &gt; about/default.html</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># curl www.magedu.net/about/linux</span>
try_files /about/default.html 
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
查看 error 日志：
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 http script var: "/about/linux"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 trying to use file: "/about/linux" "/data/nginx/html/about/linux"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 trying to use file: "/about/default.html" "/data/nginx/html/about/default.html"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 internal redirect: "/about/default.html?"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 rewrite phase: 1</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 test location: "/errorpage.html"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 test location: "/about"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 using configuration "/about"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 http cl:-1 max:1048576</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 rewrite phase: 3</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 post rewrite phase: 4</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 generic phase: 5</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 generic phase: 6</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 generic phase: 7</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 access phase: 8</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 access phase: 9</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 post access phase: 10</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 generic phase: 11</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 try files handler</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 http script var: "/about/default.html"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 trying to use file: "/about/default.html" "/data/nginx/html/about/default.html"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 try file uri: "/about/default.html"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 generic phase: 12</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 content phase: 13</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 content phase: 14</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 content phase: 15</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 content phase: 16</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 http filename: "/data/nginx/html/about/default.html"</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 add cleanup: 00000000011C3478</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 http static fd: 10</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 http set discard body</span>
2019/06/09 18:54:59 [debug] 26263<span class="hljs-comment">#0: *2 HTTP/1.1 200 OK</span>
Server: nginx/1.16.0
Date: Sun, 09 Jun 2019 10:54:59 GMT
Content-Type: text/html
Content-Length: 31
Last-Modified: Sun, 09 Jun 2019 10:45:20 GMT
Connection: keep-alive
ETag: <span class="hljs-string">"5cfce340-1f"</span>
Accept-Ranges: bytes


除了指定再次查找的文件，还可以指定返回的状态码
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

	error_page		500 502 503 504 404 /errorpage.html;
	location = /errorpage.html {
		root 	/data/nginx/html;
	}

 	location /about {
		root 	/data/nginx/html;
		index 	index.html;
		<span class="hljs-comment">#try_files       $uri	/about/default.html;</span>
		try_files	<span class="hljs-variable">$uri</span> 	<span class="hljs-variable">$uri</span>.html =888;
	}
}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl --head www.magedu.net/about/linux</span>
HTTP/1.1 888 
Server: nginx/1.16.0
Date: Sun, 09 Jun 2019 11:01:44 GMT
Content-Length: 0
Connection: keep-alive

[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>


查看日志nginx：
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http request line: "HEAD /about/linux HTTP/1.1"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http uri: "/about/linux"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http args: ""</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http exten: ""</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 posix_memalign: 0000000002224610:4096 @16</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http process request header line</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http header: "User-Agent: curl/7.29.0"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http header: "Host: www.magedu.net"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http header: "Accept: */*"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http header done</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 event timer del: 3: 35962327</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 generic phase: 0</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 rewrite phase: 1</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 test location: "/errorpage.html"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 test location: "/about"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 using configuration "/about"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http cl:-1 max:1048576</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 rewrite phase: 3</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 post rewrite phase: 4</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 generic phase: 5</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 generic phase: 6</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 generic phase: 7</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 access phase: 8</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 access phase: 9</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 post access phase: 10</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 generic phase: 11</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 try files handler</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http script var: "/about/linux"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 trying to use file: "/about/linux" "/data/nginx/html/about/linux"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http script var: "/about/linux"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http script copy: ".html"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 trying to use file: "/about/linux.html" "/data/nginx/html/about/linux.html"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 trying to use file: "=888" "/data/nginx/html=888"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http finalize request: 888, "/about/linux?" a:1, c:1</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http special response: 888, "/about/linux?"</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 http set discard body</span>
2019/06/09 19:01:44 [debug] 26305<span class="hljs-comment">#0: *2 HTTP/1.1 888 </span>
Server: nginx/1.16.0
Date: Sun, 09 Jun 2019 11:01:44 GMT
Content-Length: 0
Connection: keep-alive
</div></code></pre>
<ol start="14">
<li>nginx 长连接配置</li>
</ol>
<pre class="hljs"><code><div>长连接主要有三个配置选项：
1. keepalive_disable msie6; 该选项可以禁止具体的浏览器发起长连接
2. keepalive_requests    3; 该选项设置每个长连接最多发起的请求数
3. keepalive_timeout    65; 该选项指定长连接时长秒数，0 代表关闭该功能

通常 这三个选项配置在 http { } 配置段中
[root@localhost ~]<span class="hljs-comment"># cat  /apps/nginx/conf/nginx.conf</span>
<span class="hljs-comment"># default simple configure file for nginx 1.16 by gordon!</span>

user  nginx;
worker_processes  1;

error_log  logs/error.log  debug;

pid        logs/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    <span class="hljs-comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
    <span class="hljs-comment">#                  '$status $body_bytes_sent "$http_referer" '</span>
    <span class="hljs-comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span>

    <span class="hljs-comment">#access_log  logs/access.log  main;</span>

    sendfile        on;
    <span class="hljs-comment">#tcp_nopush     on;</span>

    keepalive_disable   	msie6;
    keepalive_requests      	3;
    keepalive_timeout     	65;

    server {
        listen       80;
        server_name  localhost;

        location / {
            root   html;
            index  index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
    include /apps/nginx/conf/conf.d/*.conf;

}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># yum install telnet -y</span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: ftp.sjtu.edu.cn
 * epel: mirror01.idc.hinet.net
 * extras: mirror.lzu.edu.cn
 * updates: mirror.lzu.edu.cn
Package 1:telnet-0.17-64.el7.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># </span>


使用 telnet 进行访问，需要手动输入 GET / HTTP/1.1 和 HOST: www.magedu.net 这两行  
然后等待 nginx 响应信息：
[root@localhost ~]<span class="hljs-comment"># telnet www.magedu.net 80</span>
Trying 127.0.0.1...
Connected to www.magedu.net.
Escape character is <span class="hljs-string">'^]'</span>.
GET / HTTP/1.1
HOST: www.magedu.net

HTTP/1.1 200 OK
Server: nginx/1.16.0
Date: Sun, 09 Jun 2019 12:18:15 GMT
Content-Type: text/html
Content-Length: 21
Last-Modified: Sat, 08 Jun 2019 13:15:58 GMT
Connection: keep-alive
ETag: <span class="hljs-string">"5cfbb50e-15"</span>
Accept-Ranges: bytes

&lt;h1&gt; It works !&lt;/h1&gt;


^CConnection closed by foreign host.
[root@localhost ~]<span class="hljs-comment">#</span>

连接成功后不到配置的 65 秒，nginx 不会断开，我们尝试 三次请求后，答案 keepalive_requests 最大值，nginx 断开连接，如图：
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># telnet www.magedu.net 80</span>
Trying 127.0.0.1...
Connected to www.magedu.net.
Escape character is <span class="hljs-string">'^]'</span>.
GET / HTTP/1.1
HOST: www.magedu.net

HTTP/1.1 200 OK
Server: nginx/1.16.0
Date: Sun, 09 Jun 2019 12:21:24 GMT
Content-Type: text/html
Content-Length: 21
Last-Modified: Sat, 08 Jun 2019 13:15:58 GMT
Connection: keep-alive
ETag: <span class="hljs-string">"5cfbb50e-15"</span>
Accept-Ranges: bytes

&lt;h1&gt; It works !&lt;/h1&gt;


GET / HTTP/1.1
HOST: www.magedu.net

HTTP/1.1 200 OK
Server: nginx/1.16.0
Date: Sun, 09 Jun 2019 12:21:41 GMT
Content-Type: text/html
Content-Length: 21
Last-Modified: Sat, 08 Jun 2019 13:15:58 GMT
Connection: keep-alive
ETag: <span class="hljs-string">"5cfbb50e-15"</span>
Accept-Ranges: bytes

&lt;h1&gt; It works !&lt;/h1&gt;

GET / HTTP/1.1
HOST: www.magedu.net

HTTP/1.1 200 OK
Server: nginx/1.16.0
Date: Sun, 09 Jun 2019 12:21:55 GMT
Content-Type: text/html
Content-Length: 21
Last-Modified: Sat, 08 Jun 2019 13:15:58 GMT
Connection: close
ETag: <span class="hljs-string">"5cfbb50e-15"</span>
Accept-Ranges: bytes

&lt;h1&gt; It works !&lt;/h1&gt;
Connection closed by foreign host.
[root@localhost ~]<span class="hljs-comment"># </span>
</div></code></pre>
<ol start="15">
<li>配置 nginx 为文件下载服务器</li>
</ol>
<pre class="hljs"><code><div>用于配置 nginx 为文件下载服务器的选项目前有4个：
1. autoindex		        on; 开启文件下载功能
2. autoindex_exact_size 	on; 显示详细的文件大小
3. autoindex_format             html; 返回页面的格式，一般使用 html 格式
4. autoindex_localtime          on; 显示服务器时间为当地时间

下面我修改一下配置文件，删除 index.hmtl文件，并创建两个空文件：
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/conf.d/pc.conf </span>
server {
	listen    		80;
	server_name		www.magedu.net;

	error_page		500 502 503 504 404 /errorpage.html;
	location = /errorpage.html {
		root 	/data/nginx/html;
	}

 	location /download {
		autoindex		on;
		autoindex_exact_size 	on;
		autoindex_format        html;
		autoindex_localtime 	on;
		root 			/data/nginx/html/pc;
	}
}
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># cd /data/nginx/html/pc/</span>
[root@localhost pc]<span class="hljs-comment"># ll</span>
total 4
-rw-r--r--. 1 root root 21 Jun  8 21:15 index.html
[root@localhost pc]<span class="hljs-comment">#</span>
[root@localhost pc]<span class="hljs-comment"># rm index.html </span>
rm: remove regular file ‘index.html’? y
[root@localhost pc]<span class="hljs-comment">#</span>
[root@localhost pc]<span class="hljs-comment"># mkdir -pv download</span>
mkdir: created directory ‘download’
[root@localhost pc]<span class="hljs-comment"># </span>
[root@localhost pc]<span class="hljs-comment"># touch download/file1.txt</span>
[root@localhost pc]<span class="hljs-comment"># </span>
[root@localhost pc]<span class="hljs-comment"># touch douwnload/file2.txt</span>
[root@localhost pc]<span class="hljs-comment"># ll download/</span>
total 0
-rw-r--r--. 1 root root 0 Jun  9 20:39 file1.txt
-rw-r--r--. 1 root root 0 Jun  9 20:39 file2.txt
[root@localhost pc]<span class="hljs-comment">#</span>
[root@localhost pc]<span class="hljs-comment"># curl http://www.magedu.net/download/</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;Index of /download/&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Index of /download/&lt;/h1&gt;&lt;hr&gt;&lt;pre&gt;&lt;a href=<span class="hljs-string">"../"</span>&gt;../&lt;/a&gt;
&lt;a href=<span class="hljs-string">"file1.txt"</span>&gt;file1.txt&lt;/a&gt;                                          09-Jun-2019 20:39                   0
&lt;a href=<span class="hljs-string">"file2.txt"</span>&gt;file2.txt&lt;/a&gt;                                          09-Jun-2019 20:39                   0
&lt;/pre&gt;&lt;hr&gt;&lt;/body&gt;
&lt;/html&gt;
[root@localhost pc]<span class="hljs-comment">#</span>
</div></code></pre>
<ol start="16">
<li>通常情况下， 我们使用 nginx 主要是发请求，下载服务器端数据和文件， 但是有些时候需要实现上传文件的<br>
功能，这时候需要后台程序和 nginx 组合完成，我们可以在 nginx 的配置文件中添加一些上传时的限制条件</li>
</ol>
<pre class="hljs"><code><div>1. client_max_body_size             10m; 上传文件的大小限制，为 0 时，不做限制。
2. client_body_buffer_size          16k; nginx 读取客户端 request 的 body 缓冲空间大小，64位操作系统建议设置为 16k
3. client_body_temp_path            /apps/nginx/temp 1 2 2; 指定 nginx 读取 request 的 body 数据时临时文件存放路径，以及使用 1 2 2 级目录存放这些临时文件

</div></code></pre>
<ol start="17">
<li>限制客户端请求方法</li>
</ol>
<pre class="hljs"><code><div>在 location 中指定，除了指定的方法外，其他方法都不允许访问，还可以配置 ip 地址一起使用

编辑配置文件：
[root@localhost ~]# 
[root@localhost ~]# 
[root@localhost ~]# cat /apps/nginx/conf/conf.d/pc.conf 
server {
	listen    		80;
	server_name		www.magedu.net;

	error_page		500 502 503 504 404 /errorpage.html;
	location = /errorpage.html {
		root 	/data/nginx/html;
	}

 	location / {
		root 			/data/nginx/html/pc;
		index			index.html;
		limit_except GET {
    			deny  all;
		}
	}
}
[root@localhost ~]# 
[root@localhost ~]# 
[root@localhost ~]# systemctl restart nginx
[root@localhost ~]# 
[root@localhost ~]# curl www.magedu.net/index.html
&lt;h1&gt; It works !&lt;/h1&gt;
[root@localhost ~]# 
[root@localhost ~]#
[root@localhost ~]# curl -X PUT www.magedu.net/index.html
&lt;html&gt;
&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.16.0&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
[root@localhost ~]# 
[root@localhost ~]# 
[root@localhost ~]#

查看 nginx 错误日志，发现确实规则生效
2019/06/10 10:06:29 [debug] 27885#0: *2 access phase: 8
2019/06/10 10:06:29 [debug] 27885#0: *2 access: 0100007F 00000000 00000000
2019/06/10 10:06:29 [error] 27885#0: *2 access forbidden by rule, client: 127.0.0.1, server: www.magedu.net, request: &quot;PUT /index.html HTTP/1.1&quot;, host: &quot;www.magedu.net&quot;
2019/06/10 10:06:29 [debug] 27885#0: *2 http finalize request: 403, &quot;/index.html?&quot; a:1, c:1
2019/06/10 10:06:29 [debug] 27885#0: *2 http special response: 403, &quot;/index.html?&quot;
2019/06/10 10:06:29 [debug] 27885#0: *2 http set discard body
2019/06/10 10:06:29 [debug] 27885#0: *2 HTTP/1.1 403 Forbidden
Server: nginx/1.16.0
Date: Mon, 10 Jun 2019 02:06:29 GMT
Content-Type: text/html
Content-Length: 153
Connection: keep-alive

2019/06/10 10:06:29 [debug]
</div></code></pre>
<ol start="18">
<li>nginx 打开文件缓存功能</li>
</ol>
<pre class="hljs"><code><div>该功能主要有以下几个配置选项
1. open_file_cache on;              是否启用缓存功能
   open_file_cache max=100 inactive=20s 最大缓存文件个数和文件缓存过期时间
2. open_file_cache_errors  off;     是否缓存查找错误的文件，默认关闭
3. open_file_cache_min_uses 1;      在缓存过期时间内，文件被访问几次才不会被定义为不活跃文件
4. open_file_cache_valid  60;       检查过期文件的判断周期，每 60 秒检查一遍
</div></code></pre>
<ol start="19">
<li>隐藏 nginx 服务器版本信息</li>
</ol>
<pre class="hljs"><code><div>server_tokens off;  显示或者隐藏服务器信息，比如在错误页面或者头文件中
</div></code></pre>

</body>
</html>
