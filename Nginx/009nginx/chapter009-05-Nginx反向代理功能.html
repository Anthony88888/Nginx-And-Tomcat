<!DOCTYPE html>
<html>
<head>
<title>chapter009-05-Nginx反向代理功能.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback";
	font-size: 14px;
	padding: 0 12px;
	line-height: 22px;
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}


body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	color: #4080D0;
	text-decoration: none;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

h1 code,
h2 code,
h3 code,
h4 code,
h5 code,
h6 code {
	font-size: inherit;
	line-height: auto;
}

a:hover {
	color: #4080D0;
	text-decoration: underline;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left: 5px solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 14px;
	line-height: 19px;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

.mac code {
	font-size: 12px;
	line-height: 18px;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

/** Theming */

.vscode-light,
.vscode-light pre code {
	color: rgb(30, 30, 30);
}

.vscode-dark,
.vscode-dark pre code {
	color: #DDD;
}

.vscode-high-contrast,
.vscode-high-contrast pre code {
	color: white;
}

.vscode-light code {
	color: #A31515;
}

.vscode-dark code {
	color: #D7BA7D;
}

.vscode-light pre:not(.hljs),
.vscode-light code > div {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre:not(.hljs),
.vscode-dark code > div {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre:not(.hljs),
.vscode-high-contrast code > div {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

.vscode-light blockquote,
.vscode-dark blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.vscode-high-contrast blockquote {
	background: transparent;
	border-color: #fff;
}
</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family:  "Meiryo", "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback";
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

</head>
<body>
<h2 id="%E7%AC%AC%E4%B9%9D%E7%AB%A0-nginx-%E6%9C%8D%E5%8A%A1%E5%99%A8">第九章 Nginx 服务器</h2>
<h3 id="%E7%AC%AC%E4%BA%94%E8%8A%82-nginx-%E7%9A%84%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8A%9F%E8%83%BD">第五节  Nginx 的反向代理功能</h3>
<h4 id="951-%E5%87%86%E5%A4%87%E4%B8%A4%E5%8F%B0-centos76-%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E4%B8%80%E5%8F%B0%E5%AE%89%E8%A3%85-nignx%EF%BC%8C%E4%B8%80%E5%8F%B0%E5%AE%89%E8%A3%85-httpd">9.5.1 准备两台 CentOS7.6 服务器，一台安装 nignx，一台安装 httpd</h4>
<pre class="hljs"><code><div>我们在之前实验的基础上，删除原来的编译好的 nginx，重新安装一遍

1. 删除之前在 /apps/ 下的 nginx 文件夹， /data 和 /var/www 文件夹
[root@localhost ~]<span class="hljs-comment"># rm -rf /apps/nginx/</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># rm -rf /data</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># rm -rf /var/www</span>
[root@localhost ~]<span class="hljs-comment"># </span>


2. 回到之前的 nginx 编译文件夹， 重新安装一次已编译好的 nginx
[root@localhost ~]<span class="hljs-comment"># cd nginx-1.16.0/</span>
[root@localhost nginx-1.16.0]<span class="hljs-comment">#</span>
[root@localhost nginx-1.16.0]<span class="hljs-comment"># make install</span>
make -f objs/Makefile install
make[1]: Entering directory /root/nginx-1.16.0
<span class="hljs-built_in">test</span> -d /apps/nginx || mkdir -p /apps/nginx
<span class="hljs-built_in">test</span> -d /apps/nginx/sbin \
	|| mkdir -p /apps/nginx/sbin
<span class="hljs-built_in">test</span> ! -f /apps/nginx/sbin/nginx \
	|| mv /apps/nginx/sbin/nginx \
		/apps/nginx/sbin/nginx.old
cp objs/nginx /apps/nginx/sbin/nginx
.
.
.省略部分安装输出信息
.
.
<span class="hljs-built_in">test</span> -d /apps/nginx/logs \
	|| mkdir -p /apps/nginx/logs
<span class="hljs-built_in">test</span> -d /apps/nginx/html \
	|| cp -R html /apps/nginx
<span class="hljs-built_in">test</span> -d /apps/nginx/logs \
	|| mkdir -p /apps/nginx/logs
make[1]: Leaving directory /root/nginx-1.16.0
[root@localhost nginx-1.16.0]<span class="hljs-comment">#</span>
[root@localhost nginx-1.16.0]<span class="hljs-comment">#</span>
[root@localhost nginx-1.16.0]<span class="hljs-comment">#</span>
[root@localhost nginx-1.16.0]<span class="hljs-comment"># cd</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@localhost ~]<span class="hljs-comment">#</span>
[root@localhost ~]<span class="hljs-comment"># echo "nginx default index page" &gt; /apps/nginx/html/index.html </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># ss -ntl</span>
State      Recv-Q Send-Q                       Local Address:Port                                      Peer Address:Port              
LISTEN     0      128                                      *:111                                                  *:*                  
LISTEN     0      128                                      *:80                                                   *:*                  
LISTEN     0      128                                      *:22                                                   *:*                  
LISTEN     0      100                              127.0.0.1:25                                                   *:*                  
LISTEN     0      128                                     :::111                                                 :::*                  
LISTEN     0      128                                     :::22                                                  :::*                  
LISTEN     0      100                                    ::1:25                                                  :::*                  
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># curl 127.0.0.1</span>
nginx default index page
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment"># </span>
[root@localhost ~]<span class="hljs-comment">#</span>

3. 配置 nginx 服务器主机名为 nginx， 关闭 selinux， 清空防火墙，配置 ip 为 192.168.7.100
[root@nginx ~]<span class="hljs-comment"># hostname</span>
nginx
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># getenforce</span>
Disabled
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># iptables -vnL</span>
Chain INPUT (policy ACCEPT 172 packets, 14468 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain OUTPUT (policy ACCEPT 142 packets, 16755 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-ens33 </span>
TYPE=<span class="hljs-string">"Ethernet"</span>
BOOTPROTO=<span class="hljs-string">"static"</span>
NAME=<span class="hljs-string">"ens33"</span>
DEVICE=<span class="hljs-string">"ens33"</span>
ONBOOT=<span class="hljs-string">"yes"</span>
IPADDR=192.168.7.100
NETMASK=255.255.255.0
GATEWAY=192.168.7.2
DNS1=223.5.5.5
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># ip a</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:ff:fa:82 brd ff:ff:ff:ff:ff:ff
    inet 192.168.7.100/24 brd 192.168.7.255 scope global ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:feff:fa82/64 scope link 
       valid_lft forever preferred_lft forever
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


4. 下面我们再准备一台 CentOS7.6 服务器，安装 httpd 充当 web 服务器
[root@web1 ~]<span class="hljs-comment"># hostname</span>
web1
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># getenforce </span>
Permissive
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># iptables -vnL</span>
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># iptables -vnL</span>
Chain INPUT (policy ACCEPT 6097 packets, 12M bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain OUTPUT (policy ACCEPT 3570 packets, 191K bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-ens32 </span>
TYPE=<span class="hljs-string">"Ethernet"</span>
BOOTPROTO=<span class="hljs-string">"static"</span>
NAME=<span class="hljs-string">"ens32"</span>
DEVICE=<span class="hljs-string">"ens32"</span>
ONBOOT=<span class="hljs-string">"yes"</span>
IPADDR=192.168.7.101
NETMASK=255.255.255.0
GATEWAY=192.168.7.2
DNS1=223.5.5.5
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># ip a</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:49:94:f4 brd ff:ff:ff:ff:ff:ff
    inet 192.168.7.101/24 brd 192.168.7.255 scope global noprefixroute ens32
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe49:94f4/64 scope link 
       valid_lft forever preferred_lft forever
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># yum install httpd -y </span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirror.jdcloud.com
 * extras: mirrors.huaweicloud.com
 * updates: mirror.jdcloud.com
Package httpd-2.4.6-90.el7.centos.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># echo "web1 server by httpd2.4" &gt; /var/www/html/index.html</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># systemctl restart httpd</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># curl 127.0.0.1</span>
web1 server by httpd2.4
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>
</div></code></pre>
<h4 id="952-%E4%BD%BF%E7%94%A8-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86-http-%E8%AF%B7%E6%B1%82%E8%87%B3-httpd-%E6%9C%8D%E5%8A%A1%E5%99%A8">9.5.2 使用 nginx 反向代理 http 请求至 httpd 服务器</h4>
<pre class="hljs"><code><div>1.修改默认的 nginx 配置添加代理
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

	location /app1 {
	    proxy_pass http://192.168.7.101:80;
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># curl 127.0.0.1</span>
default nginx page
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># curl 127.0.0.1/app1</span>
&lt;!DOCTYPE HTML PUBLIC <span class="hljs-string">"-//IETF//DTD HTML 2.0//EN"</span>&gt;
&lt;html&gt;&lt;head&gt;
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Not Found&lt;/h1&gt;
&lt;p&gt;The requested URL /app1 was not found on this server.&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


2. 下面我们在 web1 服务器上创建一个 httpd 的 app1 路径
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># mkdir -pv /var/www/html/app1</span>
mkdir: created directory ‘/var/www/html/app1’
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># echo "app1 web page by web1 server" &gt; /var/www/html/app1/index.html</span>
[root@web1 ~]<span class="hljs-comment">#  </span>
[root@web1 ~]<span class="hljs-comment"># curl 127.0.0.1/app1/</span>
app1 web page by web1 server
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>

下面我在 nginx 中进行访问测试，验证反向代理功能是否生效
[root@nginx ~]<span class="hljs-comment"># curl 127.0.0.1/app1/</span>
app1 web page by web1 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>

查看 web1 中的 httpd 访问日志，发现请求的发起方为 nginx 服务器
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># tail -1 /var/log/httpd/access_log </span>
192.168.7.100 - - [13/Oct/2019:14:46:04 +0800] <span class="hljs-string">"GET /app1/ HTTP/1.0"</span> 200 29 <span class="hljs-string">"-"</span> <span class="hljs-string">"curl/7.29.0"</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>

我们使用浏览器访问一下 192.168.7.100/app1, 然后再查看日志
[root@web1 ~]<span class="hljs-comment"># tail -2 /var/log/httpd/access_log </span>
192.168.7.100 - - [13/Oct/2019:14:46:04 +0800] <span class="hljs-string">"GET /app1/ HTTP/1.0"</span> 200 29 <span class="hljs-string">"-"</span> <span class="hljs-string">"curl/7.29.0"</span>
192.168.7.100 - - [13/Oct/2019:14:49:10 +0800] <span class="hljs-string">"GET /app1/ HTTP/1.0"</span> 200 29 <span class="hljs-string">"-"</span> <span class="hljs-string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"</span>
[root@web1 ~]<span class="hljs-comment">#</span>


3. 使用反向代理后，在 web1 服务器上我们无法获取客户端浏览器的真实IP，下面我们修改 nginx 的配置文件，实现客户端地址转发功能
   实现原理是 nginx 在转发 http 请求时在报文头中使用 X-Forwarded-For 添加了客户端的IP地址

[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

	location /app1 {
            proxy_set_header X-Forwarded-For <span class="hljs-variable">$remote_addr</span>;
	    proxy_pass http://192.168.7.101:80;
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#  </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment">#</span>


接着我们在 httpd 的访问日志中添加 X-Forwarded-For 日志键值
[root@web1 ~]<span class="hljs-comment"># vi /etc/httpd/conf/httpd.conf </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># cat /etc/httpd/conf/httpd.conf | grep "X-Forwarded-For"</span>
    LogFormat <span class="hljs-string">" \"%{X-Forwarded-For}i\"  %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\""</span> combined
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>
[root@web1 ~]<span class="hljs-comment"># systemctl restart httpd</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>

使用火狐浏览器直接访问 192.168.7.100/app1, 然后查看 httpd 的访问日志
[root@web1 ~]<span class="hljs-comment"># tail -1 /var/log/httpd/access_log </span>
 <span class="hljs-string">"192.168.7.1"</span>  192.168.7.100 - - [13/Oct/2019:15:12:22 +0800] <span class="hljs-string">"GET /app1/ HTTP/1.0"</span> 304 - <span class="hljs-string">"-"</span> <span class="hljs-string">"Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>


4. 上面我们演示了基础的反向代理功能，下面给大家列出反向代理的其他配置功能

proxy_pass_request_headers              反向代理时是否发送原请求的 http 请求头，默认为开启该功能


proxy_hide_header                       反向代理时是否隐藏指定的 http 头信息，默认 Date Server X-Pad X-Accel-等头信息不会被反向代理给客户端


proxy_pass_header                       授权允许指定的 http 头信息，被反向代理给客户端


proxy_set_header                        设置自定义的 http 头信息，反向代理给后端服务器


proxy_connect_timeout                   设置 nginx 和后端服务器建立连接的超时时长，默认为60秒，最大不得超过75秒


proxy_read_timeout                      设置 nginx 无法再次读取后端服务器响应报文的超时时长，默认是60秒，超时后 nginx 主动关闭连接


proxy_send_timeout                      设置 nginx 无法再次给后端服务器发起写操作的超时时长，默认是60秒，超时后 nginx 主动关闭连接


proxy_http_version                      设置 nginx 与后端服务器使用 http 协议通信是的版本，默认为 http1.0, 建议使用 http1.1


proxy_ignore_client_abort               当客户端和 nginx 断开连接后，nginx 是否还和后端服务器处理代理的请求，默认为 off ，中断后 nginx 继续处理代理的请求


proxy_headers_hash_bucket_size          给 proxy_hide_header 和 proxy_set_header 设置哈希结构中桶的大小，默认是 64 


proxy_headers_hash_max_size             给 proxy_hide_header 和 proxy_set_header 设置哈希表结构的大小，默认是 512


server_names_hash_max_size              配置用于存放主机名的哈希表空间大小，默认是 512


server_names_hash_bucket_size           配置用于存放主机名的哈希结构中桶的大小，默认是 32, 64, 128, 具体值取决于服务器 CPU 缓存线的大小 

</div></code></pre>
<h4 id="953-%E4%BD%BF%E7%94%A8-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%BC%93%E5%AD%98%E5%8A%9F%E8%83%BD">9.5.3 使用 nginx 反向代理缓存功能</h4>
<pre class="hljs"><code><div>1. 我们在上一个实验的基础上，修改 nginx 配置文件，添加代理缓存功能
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    proxy_cache_path /apps/nginx/proxycache levels=1:2:2 keys_zone=proxycache:512m inactive=10m max_size=1g;	

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

	location /app1 {
	    proxy_pass http://192.168.7.101:80;
            proxy_set_header X-Forwarded-For <span class="hljs-variable">$remote_addr</span>;
	    proxy_connect_timeout 60s;
            proxy_cache proxycache;
	    proxy_cache_key <span class="hljs-variable">$request_uri</span>;
            proxy_cache_valid 200 302 301 10m;
	    proxy_cache_valid any 1m;
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># curl 127.0.0.1/app1/</span>
app1 web page by web1 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># ls -al /apps/nginx/proxycache/</span>
total 0
drwx------  3 nginx nginx  15 Oct 15 16:32 .
drwxr-xr-x 12 nginx nginx 169 Oct 15 16:16 ..
drwx------  3 nginx nginx  16 Oct 15 16:32 b
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># tree /apps/nginx/proxycache/</span>
/apps/nginx/proxycache/
└── b
    └── 27
        └── 73
            └── 45efea0da7a0718cc36ddeda8747327b

3 directories, 1 file
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


下面我们在开启缓存功能后添加几个 http 头部信息，方便聊得代理情况
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    proxy_cache_path /apps/nginx/proxycache levels=1:2:2 keys_zone=proxycache:512m inactive=10m max_size=1g;	

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

	location /app1 {
	    proxy_pass http://192.168.7.101:80;
            proxy_set_header X-Forwarded-For <span class="hljs-variable">$remote_addr</span>;
	    proxy_connect_timeout 60s;
            proxy_cache proxycache;
	    proxy_cache_key <span class="hljs-variable">$request_uri</span>;
            proxy_cache_valid 200 302 301 10m;
	    proxy_cache_valid any 1m;
	    add_header X-Via <span class="hljs-variable">$server_addr</span>;
	    add_header X-Cache <span class="hljs-variable">$upstream_cache_status</span>;
	    add_header X-Accel <span class="hljs-variable">$server_name</span>;
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


删除 之前的缓存页面，查看缓存是否命中
[root@nginx ~]<span class="hljs-comment"># rm -rf /apps/nginx/proxycache/*</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># curl -v 127.0.0.1/app1/</span>
* About to connect() to 127.0.0.1 port 80 (<span class="hljs-comment">#0)</span>
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 80 (<span class="hljs-comment">#0)</span>
&gt; GET /app1/ HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: 127.0.0.1
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Server: nginx/1.16.0
&lt; Date: Tue, 15 Oct 2019 08:38:41 GMT
&lt; Content-Type: text/html; charset=UTF-8
&lt; Content-Length: 29
&lt; Connection: keep-alive
&lt; Last-Modified: Sun, 13 Oct 2019 06:43:09 GMT
&lt; ETag: <span class="hljs-string">"1d-594c5107e499e"</span>
&lt; X-Via: 127.0.0.1
&lt; X-Cache: MISS
&lt; X-Accel: www.magedu.com
&lt; Accept-Ranges: bytes
&lt; 
app1 web page by web1 server
* Connection <span class="hljs-comment">#0 to host 127.0.0.1 left intact</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># tree /apps/nginx/proxycache/</span>
/apps/nginx/proxycache/
└── b
    └── 27
        └── 73
            └── 45efea0da7a0718cc36ddeda8747327b

3 directories, 1 file
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


再次访问相同页面，缓存命中
[root@nginx ~]<span class="hljs-comment"># curl -v 127.0.0.1/app1/</span>
* About to connect() to 127.0.0.1 port 80 (<span class="hljs-comment">#0)</span>
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 80 (<span class="hljs-comment">#0)</span>
&gt; GET /app1/ HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: 127.0.0.1
&gt; Accept: */*
&gt; 
&lt; HTTP/1.1 200 OK
&lt; Server: nginx/1.16.0
&lt; Date: Tue, 15 Oct 2019 08:38:45 GMT
&lt; Content-Type: text/html; charset=UTF-8
&lt; Content-Length: 29
&lt; Connection: keep-alive
&lt; Last-Modified: Sun, 13 Oct 2019 06:43:09 GMT
&lt; ETag: <span class="hljs-string">"1d-594c5107e499e"</span>
&lt; X-Via: 127.0.0.1
&lt; X-Cache: HIT
&lt; X-Accel: www.magedu.com
&lt; Accept-Ranges: bytes
&lt; 
app1 web page by web1 server
* Connection <span class="hljs-comment">#0 to host 127.0.0.1 left intact</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>
</div></code></pre>
<h4 id="954-%E4%BD%BF%E7%94%A8-nginx-%E4%BD%BF%E7%94%A8-upstream-%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8A%9F%E8%83%BD">9.5.4 使用 nginx 使用 upstream 实现负载均衡功能</h4>
<pre class="hljs"><code><div>1. 我们再准备一台 CentOS7.6 服务器，关闭 selinux，清空防火墙，安装好 httpd 服务器

[root@web2 ~]<span class="hljs-comment"># hostname</span>
web2
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># getenforce</span>
Permissive
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># iptables -vnL</span>
Chain INPUT (policy ACCEPT 6744 packets, 12M bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         

Chain OUTPUT (policy ACCEPT 4375 packets, 249K bytes)
 pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     <span class="hljs-built_in">source</span>               destination         
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># cat /etc/sysconfig/network-scripts/ifcfg-ens33 </span>
TYPE=<span class="hljs-string">"Ethernet"</span>
BOOTPROTO=<span class="hljs-string">"static"</span>
NAME=<span class="hljs-string">"ens33"</span>
DEVICE=<span class="hljs-string">"ens33"</span>
ONBOOT=<span class="hljs-string">"yes"</span>
IPADDR=192.168.7.102
NETMASK=255.255.0.0
GATEWAY=192.168.7.2
DNS1=223.5.5.5
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># ip a</span>
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:c5:14:0d brd ff:ff:ff:ff:ff:ff
    inet 192.168.7.102/16 brd 192.168.255.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fec5:140d/64 scope link 
       valid_lft forever preferred_lft forever
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># yum install httpd -y </span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.huaweicloud.com
 * extras: mirrors.huaweicloud.com
 * updates: mirrors.huaweicloud.com
Package httpd-2.4.6-90.el7.centos.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># echo "web2 server by httpd2.4" &gt; /var/www/html/index.html</span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># mkdir -pv /var/www/html/app1</span>
mkdir: created directory ‘/var/www/html/app1’
[root@web2 ~]<span class="hljs-comment">#  </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># echo "app1 web page by web2 server" &gt; /var/www/html/app1/index.html</span>
[root@web2 ~]<span class="hljs-comment">#</span>
[root@web2 ~]<span class="hljs-comment">#</span>
[root@web2 ~]<span class="hljs-comment"># systemctl restart httpd</span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># curl 127.0.0.1/app1/index.html</span>
app1 web page by web2 server
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment">#  </span>
[root@web2 ~]<span class="hljs-comment"># curl 127.0.0.1</span>
web2 server by httpd2.4
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># </span>



2. 我们修改 nginx 的配置文件，配置 nginx 负载均衡 web1 和 web2 服务器

[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    upstream webserver {
        server 192.168.7.101:80 weight=1 fail_timeout=5s max_fails=3;
        server 192.168.7.102:80 weight=1 fail_timeout=5s max_fails=3;
    }

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

	location /app1 {
	    proxy_pass http://webserver;
            proxy_set_header X-Forwarded-For <span class="hljs-variable">$remote_addr</span>;
	    proxy_connect_timeout 60s;
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>

访问进行测试:
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/;done</span>
app1 web page by web1 server
app1 web page by web2 server
app1 web page by web1 server
app1 web page by web2 server
app1 web page by web1 server
app1 web page by web2 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>


3. nginx 配置负载均衡时，可以使用 down 标记指定服务器下线
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf | grep down</span>
        server 192.168.7.101:80 weight=1 fail_timeout=5s max_fails=3 down;
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl reload nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/;done</span>
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


4. nginx 也可以使用 backup 标记指定服务器为后备服务器，当其他服务器无法正常响应时才启用
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf | grep backup;</span>
        server 192.168.7.101:80 weight=1 fail_timeout=5s max_fails=3 backup;
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl reload nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/;done</span>
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>



下面我们关闭 web2 服务器:
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># systemctl stop httpd</span>
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment"># ss -ntl</span>
State      Recv-Q Send-Q                       Local Address:Port                                      Peer Address:Port              
LISTEN     0      128                                      *:22                                                   *:*                  
LISTEN     0      100                              127.0.0.1:25                                                   *:*                  
LISTEN     0      128                                     :::22                                                  :::*                  
LISTEN     0      100                                    ::1:25                                                  :::*                  
[root@web2 ~]<span class="hljs-comment"># </span>
[root@web2 ~]<span class="hljs-comment">#</span>


使用 nginx 再次测试:
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/;done</span>
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


5. nginx 默认的负载均衡算法是轮询，下面我们使用 <span class="hljs-built_in">hash</span> 客户端请求地址的方法进行调度
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    upstream webserver {
        ip_hash;
        server 192.168.7.101:80 weight=1 fail_timeout=5s max_fails=3;
        server 192.168.7.102:80 weight=1 fail_timeout=5s max_fails=3;
    }

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

	location /app1 {
	    proxy_pass http://webserver;
            proxy_set_header X-Forwarded-For <span class="hljs-variable">$remote_addr</span>;
	    proxy_connect_timeout 60s;
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/;done</span>
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
app1 web page by web1 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


6. 除了可以 <span class="hljs-built_in">hash</span> 原地址，nginx 还支持 <span class="hljs-built_in">hash</span> 指定数据信息, 下面我们在 web1 和 web2 上分别再创建一个页面，
   配置使用 <span class="hljs-built_in">hash</span> 请求文件名称来调度请求

web1:
[root@web1 ~]<span class="hljs-comment"># echo web1 &gt; /var/www/html/app1/test.html</span>
[root@web1 ~]<span class="hljs-comment">#</span>

web2:
[root@web2 ~]<span class="hljs-comment"># echo web2 &gt; /var/www/html/app1/test.html</span>
[root@web2 ~]<span class="hljs-comment">#</span>

nginx:
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf | grep -A 4 upstream</span>
    upstream webserver {
	<span class="hljs-built_in">hash</span> <span class="hljs-variable">$request_uri</span> consistent;
        server 192.168.7.101:80 weight=1 fail_timeout=5s max_fails=3;
        server 192.168.7.102:80 weight=1 fail_timeout=5s max_fails=3;
    }

[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/;done</span>
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
app1 web page by web2 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/test.html;done</span>
web1
web1
web1
web1
web1
web1
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>



7. nginx 可以根据后端服务连接的繁忙情况优先把请求调度给连接数比较少的服务器，配置如下：
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf | grep -A 4 upstream</span>
    upstream webserver {
	least_conn;
        server 192.168.7.101:80 weight=1 fail_timeout=5s max_fails=3;
        server 192.168.7.102:80 weight=1 fail_timeout=5s max_fails=3;
    }
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 127.0.0.1/app1/;done</span>
app1 web page by web1 server
app1 web page by web2 server
app1 web page by web1 server
app1 web page by web2 server
app1 web page by web1 server
app1 web page by web2 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>

</div></code></pre>
<h4 id="955-%E4%BD%BF%E7%94%A8-nginx-%E7%9A%84-stream-%E5%AE%9E%E7%8E%B0%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8A%9F%E8%83%BD">9.5.5 使用 nginx 的 stream 实现四层负载均衡功能</h4>
<pre class="hljs"><code><div>1. 我们在上一个实验的基础上配置 nginx 的 stream 功能，让 nginx 监听在
   本机的 8080 端口，使用四层负载均衡技术，负载请求数据到 web1 和 web2
   服务器

[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}


stream {
	upstream web_servers {
		server 192.168.7.101:80 max_fails=3 fail_timeout=30s;
		server 192.168.7.102:80 max_fails=3 fail_timeout=30s;
	}

	server {
		listen 192.168.7.100:8080;
		proxy_connect_timeout 3s;
		proxy_timeout 3s;
		proxy_pass web_servers;	
	}

}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># ss -ntl</span>
State      Recv-Q Send-Q                       Local Address:Port                                      Peer Address:Port              
LISTEN     0      128                                      *:111                                                  *:*                  
LISTEN     0      128                          192.168.7.100:8080                                                 *:*                  
LISTEN     0      128                                      *:80                                                   *:*                  
LISTEN     0      128                                      *:22                                                   *:*                  
LISTEN     0      100                              127.0.0.1:25                                                   *:*                  
LISTEN     0      128                                     :::111                                                 :::*                  
LISTEN     0      128                                     :::22                                                  :::*                  
LISTEN     0      100                                    ::1:25                                                  :::*                  
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 192.168.7.100:8080;done</span>
web1 server by httpd2.4
web2 server by httpd2.4
web1 server by httpd2.4
web2 server by httpd2.4
web1 server by httpd2.4
web2 server by httpd2.4
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 192.168.7.100:8080/app1/index.html;done</span>
app1 web page by web1 server
app1 web page by web2 server
app1 web page by web1 server
app1 web page by web2 server
app1 web page by web1 server
app1 web page by web2 server
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># for((i=0;i&lt;=5;i++));do curl 192.168.7.100:8080/app1/test.html;done</span>
web1
web2
web1
web2
web1
web2
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


2. 下面我们配置实现 nginx 代理 mysql 服务
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}


stream {
	upstream mysql{
		server 192.168.7.101:3306 max_fails=3 fail_timeout=30s;
	}

	server {
		listen 192.168.7.100:3306;
		proxy_connect_timeout 3s;
		proxy_timeout 3s;
		proxy_pass mysql;	
	}

}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># ss -ntl</span>
State      Recv-Q Send-Q                       Local Address:Port                                      Peer Address:Port              
LISTEN     0      128                          192.168.7.100:3306                                                 *:*                  
LISTEN     0      128                                      *:111                                                  *:*                  
LISTEN     0      128                                      *:80                                                   *:*                  
LISTEN     0      128                                      *:22                                                   *:*                  
LISTEN     0      100                              127.0.0.1:25                                                   *:*                  
LISTEN     0      128                                     :::111                                                 :::*                  
LISTEN     0      128                                     :::22                                                  :::*                  
LISTEN     0      100                                    ::1:25                                                  :::*                  
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>


web1 服务器上安装 mariadb-serve 服务
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># yum install mariadb-server -y </span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirror.jdcloud.com
 * epel: mirrors.tuna.tsinghua.edu.cn
 * extras: mirror.jdcloud.com
 * updates: mirror.jdcloud.com
Package 1:mariadb-server-5.5.64-1.el7.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># systemctl restart mariadb</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># mysql -uroot -p</span>
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 2
Server version: 5.5.64-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type <span class="hljs-string">'help;'</span> or <span class="hljs-string">'\h'</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">'\c'</span> to clear the current input statement.

MariaDB [(none)]&gt; 
MariaDB [(none)]&gt; use mysql;
Reading table information <span class="hljs-keyword">for</span> completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [mysql]&gt; 
MariaDB [mysql]&gt; update user  <span class="hljs-built_in">set</span> Host=<span class="hljs-string">'%'</span> <span class="hljs-built_in">where</span> Host=<span class="hljs-string">"localhost"</span>;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

MariaDB [mysql]&gt; 
MariaDB [mysql]&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)

MariaDB [mysql]&gt;
MariaDB [(none)]&gt; <span class="hljs-built_in">exit</span>
Bye
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>



在 nginx 服务器上安装 mysql 客户端，然后连接数据库
[root@nginx ~]<span class="hljs-comment"># yum install mariadb -y</span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.huaweicloud.com
 * epel: fedora.cs.nctu.edu.tw
 * extras: mirror.jdcloud.com
 * updates: mirror.jdcloud.com
Package 1:mariadb-5.5.64-1.el7.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># mysql -h 192.168.7.100 -uroot -p</span>
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 5
Server version: 5.5.64-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type <span class="hljs-string">'help;'</span> or <span class="hljs-string">'\h'</span> <span class="hljs-keyword">for</span> <span class="hljs-built_in">help</span>. Type <span class="hljs-string">'\c'</span> to clear the current input statement.

MariaDB [(none)]&gt; 
MariaDB [(none)]&gt; <span class="hljs-built_in">exit</span>
Bye
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>
</div></code></pre>
<h4 id="956-%E4%BD%BF%E7%94%A8-nginx-%E4%BD%9C%E4%B8%BA-http-%E5%8D%8F%E8%AE%AE%E5%8D%B8%E8%BD%BD%E5%99%A8-%E4%B8%8E-php-%E7%A8%8B%E5%BA%8F%E9%80%9A%E4%BF%A1">9.5.6 使用 nginx 作为 http 协议卸载器 与 php 程序通信</h4>
<pre class="hljs"><code><div>1. 我们在 nginx 服务器上使用 yum 安装一个 php-fpm 程序
 
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># yum install php-fpm -y </span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.huaweicloud.com
 * epel: fedora.cs.nctu.edu.tw
 * extras: mirror.jdcloud.com
 * updates: mirror.jdcloud.com
Package php-fpm-5.4.16-46.el7.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

        location ~ \.php$ {
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME /var/www<span class="hljs-variable">$fastcgi_script_name</span>;
            include fastcgi_params;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># mkdir -pv /var/www/</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># vi /var/www/index.php </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat  /var/www/index.php </span>
&lt;?php
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;h1&gt;create by php-fpm&lt;/h1&gt;\n"</span>;
        <span class="hljs-built_in">echo</span> date(<span class="hljs-string">"Y.m.d"</span>).<span class="hljs-string">"\n"</span>;
?&gt;
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart php-fpm </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># ss -ntl</span>
State      Recv-Q Send-Q                       Local Address:Port                                      Peer Address:Port              
LISTEN     0      128                              127.0.0.1:9000                                                 *:*                  
LISTEN     0      128                                      *:111                                                  *:*                  
LISTEN     0      128                                      *:80                                                   *:*                  
LISTEN     0      128                                      *:22                                                   *:*                  
LISTEN     0      100                              127.0.0.1:25                                                   *:*                  
LISTEN     0      128                                     :::111                                                 :::*                  
LISTEN     0      128                                     :::22                                                  :::*                  
LISTEN     0      100                                    ::1:25                                                  :::*                  
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># curl 127.0.0.1</span>
default nginx page
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># curl 127.0.0.1/index.php</span>
&lt;h1&gt;create by php-fpm&lt;/h1&gt;
2019.10.16
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>



2. 下面我们尝试将在 web1 服务器上安装 php-fpm，让 nginx 请求 web 的 php 服务

[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># yum install php-fpm -y </span>
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirror.jdcloud.com
 * epel: mirrors.tuna.tsinghua.edu.cn
 * extras: mirror.jdcloud.com
 * updates: mirror.lzu.edu.cn
Package php-fpm-5.4.16-46.el7.x86_64 already installed and latest version
Nothing to <span class="hljs-keyword">do</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># mkdir -pv /var/www/php</span>
mkdir: created directory ‘/var/www/php’
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># vi /var/www/php/index.php</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># cat  /var/www/php/index.php</span>
&lt;?php
	<span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;h1&gt;create by php-fpm on web1 server&lt;/h1&gt;\n"</span>;
        <span class="hljs-built_in">echo</span> date(<span class="hljs-string">"Y.m.d"</span>).<span class="hljs-string">"\n"</span>;
?&gt;
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># rpm -ql php-fpm</span>
/etc/logrotate.d/php-fpm
/etc/php-fpm.conf
/etc/php-fpm.d
/etc/php-fpm.d/www.conf
/etc/sysconfig/php-fpm
/run/php-fpm
/usr/lib/systemd/system/php-fpm.service
/usr/lib/tmpfiles.d/php-fpm.conf
/usr/sbin/php-fpm
/usr/share/doc/php-fpm-5.4.16
/usr/share/doc/php-fpm-5.4.16/fpm_LICENSE
/usr/share/doc/php-fpm-5.4.16/php-fpm.conf.default
/usr/share/fpm
/usr/share/fpm/status.html
/usr/share/man/man8/php-fpm.8.gz
/var/<span class="hljs-built_in">log</span>/php-fpm
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># vi /etc/php-fpm.d/www.conf </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># cat  /etc/php-fpm.d/www.conf | grep 192.168</span>
listen = 192.168.7.101:9000
listen.allowed_clients = 192.168.7.100
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># systemctl restart php-fpm</span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># ss -ntl</span>
State      Recv-Q Send-Q                       Local Address:Port                                      Peer Address:Port              
LISTEN     0      128                          192.168.7.101:9000                                                 *:*                  
LISTEN     0      128                                      *:22                                                   *:*                  
LISTEN     0      100                              127.0.0.1:25                                                   *:*                  
LISTEN     0      128                                     :::80                                                  :::*                  
LISTEN     0      128                                     :::22                                                  :::*                  
LISTEN     0      100                                    ::1:25                                                  :::*                  
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment"># </span>
[root@web1 ~]<span class="hljs-comment">#</span>


下面修改 nginx 的转发地址到 web1 服务器
[root@nginx ~]<span class="hljs-comment"># vi /apps/nginx/conf/nginx.conf</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># cat /apps/nginx/conf/nginx.conf</span>
worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen       80;
        server_name  www.magedu.com;
	
        location / {
            root   html;
            index  index.html index.htm;
        }

        location ~ \.php$ {
            fastcgi_pass 192.168.7.101:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME /var/www/php<span class="hljs-variable">$fastcgi_script_name</span>;
            include fastcgi_params;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl stop php-fpm</span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># systemctl restart nginx</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># ss -ntl</span>
State      Recv-Q Send-Q                       Local Address:Port                                      Peer Address:Port              
LISTEN     0      128                                      *:111                                                  *:*                  
LISTEN     0      128                                      *:80                                                   *:*                  
LISTEN     0      128                                      *:22                                                   *:*                  
LISTEN     0      100                              127.0.0.1:25                                                   *:*                  
LISTEN     0      128                                     :::111                                                 :::*                  
LISTEN     0      128                                     :::22                                                  :::*                  
LISTEN     0      100                                    ::1:25                                                  :::*                  
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># curl 127.0.0.1/index.php</span>
&lt;h1&gt;create by php-fpm on web1 server&lt;/h1&gt;
2019.10.16
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment"># </span>
[root@nginx ~]<span class="hljs-comment">#</span>
</div></code></pre>

</body>
</html>
